<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwissPark - Le futur du parking en Suisse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sp-pink: #E6007E; --sp-dark: #2D2D2D; }
        body { font-family: 'Montserrat', sans-serif; background: #f8f9fa; overscroll-behavior: none; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .btn-pink { background: var(--sp-pink); color: white; font-weight: 800; transition: all 0.3s; border: none; cursor: pointer; }
        .btn-pink:active { transform: scale(0.95); }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 32px 32px 0 0; z-index: 1000; transform: translateY(100%); transition: transform 0.5s cubic-bezier(0.32, 0.72, 0, 1); padding: 1.5rem; box-shadow: 0 -10px 40px rgba(0,0,0,0.08); }
        .bottom-sheet.active { transform: translateY(0); }
        .timer-container { position: relative; width: 260px; height: 260px; margin: 1.5rem auto; }
        .timer-wheel-svg { transform: rotate(-90deg); cursor: grab; }
        .timer-wheel-svg:active { cursor: grabbing; }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: white; border-top: 1px solid #f1f1f1; display: flex; justify-content: space-around; align-items: center; z-index: 1001; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #9ca3af; text-decoration: none; font-weight: 700; gap: 5px; text-transform: uppercase; letter-spacing: 0.5px; }
        .nav-item.active { color: var(--sp-pink); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2000; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 32px 32px 0 0; padding: 2rem; position: relative; }
        .vehicle-tag { background: #1f2937; color: white; padding: 6px 14px; border-radius: 8px; font-family: 'Courier New', monospace; font-weight: 800; letter-spacing: 1.5px; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3); border: 2px solid #374151; }
        .twint-button { background: #000; color: #fff; padding: 1rem; border-radius: 16px; font-weight: 800; display: flex; align-items: center; justify-content: center; gap: 10px; width: 100%; transition: 0.2s; }
        .twint-button img { height: 24px; }
        .twint-button:active { background: #333; }
        .parking-active-bg { background: linear-gradient(180deg, #E6007E 0%, #B30062 100%); color: white; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <!-- Header UI -->
    <div class="fixed top-8 left-1/2 -translate-x-1/2 w-[92%] max-w-md z-[1000]">
        <div class="glass-panel p-4 flex items-center gap-3">
            <div class="bg-pink-600 text-white w-10 h-10 rounded-xl flex items-center justify-center font-black text-xl">P</div>
            <div class="flex-1">
                <input type="text" id="zone-search" placeholder="Code de zone ou adresse" class="bg-transparent border-none outline-none w-full font-bold text-gray-800 text-lg">
            </div>
            <button class="text-gray-400 text-xl"><i class="fas fa-camera"></i></button>
        </div>
    </div>

    <!-- Initial Bottom Sheet -->
    <div id="initial-sheet" class="bottom-sheet active">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
        <div class="flex justify-between items-start mb-4">
            <div>
                <h2 id="current-zone-name" class="text-2xl font-black text-gray-900 leading-tight">Zone 1001</h2>
                <p class="text-gray-500 font-semibold flex items-center gap-1"><i class="fas fa-location-arrow text-xs text-pink-600"></i> Lausanne, Riponne</p>
            </div>
            <div class="bg-pink-50 text-pink-600 px-3 py-1.5 rounded-xl font-bold text-sm" id="current-zone-price">2.50 CHF/h</div>
        </div>

        <div class="timer-container">
            <svg class="timer-wheel-svg" width="260" height="260">
                <circle cx="130" cy="130" r="115" fill="none" stroke="#fdf2f8" stroke-width="20" />
                <circle id="timer-progress" cx="130" cy="130" r="115" fill="none" stroke="#E6007E" stroke-width="20" stroke-dasharray="722.5" stroke-dashoffset="600" stroke-linecap="round" />
                <circle id="timer-handle" cx="245" cy="130" r="15" fill="white" stroke="#E6007E" stroke-width="4" style="filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1))" />
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <span id="display-time" class="text-5xl font-black text-gray-900">01:00</span>
                <span class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mt-1">Durée du parking</span>
            </div>
        </div>

        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100 mb-6 cursor-pointer" onclick="openModal('vehicle-modal')">
            <div class="flex items-center gap-3">
                <i class="fas fa-car text-gray-400 text-xl" id="active-vehicle-icon"></i>
                <span id="selected-vehicle-display" class="font-bold text-gray-800">Sélectionner...</span>
            </div>
            <span class="text-pink-600 font-bold text-sm">Changer</span>
        </div>

        <button onclick="startParking()" class="btn-pink w-full py-5 rounded-2xl text-xl shadow-lg shadow-pink-200 uppercase tracking-wider">Démarrer</button>
    </div>

    <!-- Active Session Bottom Sheet -->
    <div id="session-sheet" class="bottom-sheet parking-active-bg">
        <div class="w-12 h-1.5 bg-white/30 rounded-full mx-auto mb-6"></div>
        <div class="text-center mb-6">
            <p class="uppercase text-[11px] font-black tracking-widest opacity-80 mb-1">Session Active</p>
            <h1 id="parking-timer" class="text-6xl font-black mb-2">00:00:00</h1>
            <div class="flex justify-center gap-3 font-bold text-lg">
                <span id="current-price-session">0.00 CHF</span>
                <span class="opacity-50">|</span>
                <span id="session-zone-display">1001</span>
            </div>
        </div>
        <div class="flex gap-4">
            <button class="flex-1 bg-white/20 backdrop-blur-md py-5 rounded-2xl font-black uppercase text-sm border border-white/30">Prolonger</button>
            <button onclick="stopParking()" class="flex-1 bg-white py-5 rounded-2xl font-black uppercase text-sm text-pink-600 shadow-xl">Arrêter</button>
        </div>
    </div>

    <!-- TWINT Modal -->
    <div id="twint-modal" class="modal">
        <div class="modal-content text-center">
            <div class="absolute top-4 right-4 text-gray-300" onclick="closeModal('twint-modal')"><i class="fas fa-times text-xl"></i></div>
            <img src="https://www.twint.ch/wp-content/themes/twint/img/twint-logo.svg" class="h-10 mx-auto mb-6" alt="TWINT">
            <h3 class="text-2xl font-black mb-2">Paiement Instantané</h3>
            <p class="text-gray-500 font-semibold mb-8 text-sm px-6">Vous allez être redirigé vers votre application TWINT pour valider le montant de <span id="payment-amount" class="text-gray-900 font-black">0.00 CHF</span>.</p>
            
            <div class="bg-gray-50 p-6 rounded-3xl mb-8 border-2 border-dashed border-gray-200">
                <!-- QR Code Simulation -->
                <div class="w-48 h-48 bg-white mx-auto rounded-2xl flex items-center justify-center p-4 shadow-sm border border-gray-100">
                   <div class="w-full h-full bg-[url('https://upload.wikimedia.org/wikipedia/commons/d/d0/QR_code_for_mobile_English_Wikipedia.svg')] bg-cover opacity-80"></div>
                </div>
                <p class="text-[10px] text-gray-400 font-bold mt-4 uppercase tracking-widest">Scannez ou cliquez ci-dessous</p>
            </div>

            <button onclick="completePayment()" class="twint-button">
                Ouvrir l'application TWINT
            </button>
            <button onclick="closeModal('twint-modal')" class="w-full py-4 text-gray-400 font-bold text-sm mt-2">Plus tard</button>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-black mb-6">Mes Véhicules</h3>
            <div id="vehicle-list" class="space-y-4 mb-8"></div>
            <form onsubmit="addVehicle(event)" class="space-y-4">
                <input type="text" id="plate-number" placeholder="PLAQUE (ex: VD 123456)" class="w-full bg-gray-50 p-5 rounded-2xl border border-gray-100 font-black text-xl text-center uppercase focus:border-pink-500 outline-none transition" required>
                <button type="submit" class="btn-pink w-full py-5 rounded-2xl font-black uppercase shadow-lg">Ajouter</button>
            </form>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div id="phone-auth-container">
                <h3 class="text-3xl font-black mb-2 leading-tight">Bienvenue sur SwissPark</h3>
                <p class="text-gray-500 font-semibold mb-8">Veuillez vous connecter avec votre numéro de mobile.</p>
                <form id="phone-form" class="space-y-4">
                    <div class="bg-gray-50 p-5 rounded-2xl border border-gray-100 flex items-center gap-3">
                        <img src="https://flagcdn.com/ch.svg" class="w-6 h-4 rounded-sm shadow-sm" alt="CH">
                        <input type="tel" id="phone-number" placeholder="+41 79 000 00 00" class="bg-transparent border-none outline-none font-bold text-xl text-gray-800 w-full" required>
                    </div>
                    <div id="recaptcha-container"></div>
                    <button type="submit" class="btn-pink w-full py-5 rounded-2xl font-black uppercase text-lg shadow-lg">Continuer</button>
                </form>
            </div>
            <div id="verification-container" class="hidden">
                <h3 class="text-3xl font-black mb-2 leading-tight">Vérification</h3>
                <p class="text-gray-500 font-semibold mb-8">Entrez le code envoyé au <span id="display-phone" class="text-gray-900 font-black"></span></p>
                <form id="verification-form" class="space-y-6">
                    <input type="text" id="verification-code" placeholder="123456" class="w-full bg-gray-50 p-6 rounded-2xl border border-gray-100 text-center text-4xl font-black tracking-[0.3em] outline-none focus:border-pink-500" required>
                    <button type="submit" class="btn-pink w-full py-5 rounded-2xl font-black uppercase text-lg">Valider</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="nav-bar">
        <a href="#" class="nav-item active"><i class="fas fa-map-marked-alt text-2xl"></i><span>Carte</span></a>
        <a href="#" class="nav-item"><i class="fas fa-history text-2xl"></i><span>Activité</span></a>
        <a href="#" class="nav-item" onclick="openModal('vehicle-modal')"><i class="fas fa-car text-2xl"></i><span>Véhicules</span></a>
        <a href="#" class="nav-item" onclick="openModal('auth-modal')"><i class="fas fa-user-circle text-2xl"></i><span>Compte</span></a>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>

    <script>
        // --- Firebase ---
        const firebaseConfig = { 
            apiKey: "AIzaSyB3uDEtxEcwxuRRqItU1G-sn5cAWse-gpc", 
            authDomain: "swisspark-e4c0a.firebaseapp.com", 
            projectId: "swisspark-e4c0a", 
            storageBucket: "swisspark-e4c0a.firebasestorage.app", 
            messagingSenderId: "852079002086", 
            appId: "1:852079002086:web:e4de222417deff1aabd627" 
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.languageCode = 'fr';

        // --- App State ---
        let vehicles = JSON.parse(localStorage.getItem('sp_vehicles')) || [];
        let activeSession = null;
        let timerInterval = null;
        let startTime = null;
        let selectedDuration = 1; // hours
        let selectedZone = { id: 1001, name: "Lausanne Centre", price: 2.50 };

        // --- Map Init ---
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([46.5197, 6.6323], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

        const parkingSpots = [
            { id: 1001, name: "Lausanne Centre", pos: [46.5197, 6.6323], price: 2.50 },
            { id: 1002, name: "Lausanne Gare", pos: [46.5167, 6.6293], price: 3.00 },
            { id: 2001, name: "Genève Centre", pos: [46.2044, 6.1432], price: 4.50 },
            { id: 3001, name: "Zurich HB", pos: [47.3779, 8.5402], price: 5.00 }
        ];

        parkingSpots.forEach(spot => {
            const marker = L.divIcon({
                className: 'custom-marker',
                html: `<div class="bg-[#E6007E] text-white p-2 rounded-lg font-black shadow-lg text-sm border-2 border-white">${spot.price.toFixed(2)}</div>`
            });
            const m = L.marker(spot.pos, { icon: marker }).addTo(map);
            m.on('click', () => {
                selectedZone = spot;
                document.getElementById('current-zone-name').innerText = `Zone ${spot.id}`;
                document.getElementById('current-zone-price').innerText = `${spot.price.toFixed(2)} CHF/h`;
                map.panTo(spot.pos);
            });
        });

        // --- Timer Logic ---
        const progress = document.getElementById('timer-progress');
        const handle = document.getElementById('timer-handle');
        const radius = 115;
        const circumference = 2 * Math.PI * radius;
        progress.style.strokeDasharray = circumference;

        function setTimer(hours) {
            selectedDuration = Math.min(24, Math.max(0.5, hours));
            const angle = (selectedDuration / 12) * 360; // Max 12 hours visual
            const offset = circumference - (Math.min(angle, 359) / 360) * circumference;
            progress.style.strokeDashoffset = offset;
            
            // Move handle
            const rad = (angle - 90) * (Math.PI / 180);
            const hx = 130 + radius * Math.cos(rad);
            const hy = 130 + radius * Math.sin(rad);
            handle.setAttribute('cx', hx);
            handle.setAttribute('cy', hy);

            const displayH = Math.floor(selectedDuration);
            const displayM = Math.floor((selectedDuration % 1) * 60);
            document.getElementById('display-time').innerText = `${displayH.toString().padStart(2, '0')}:${displayM.toString().padStart(2, '0')}`;
        }

        // Draggable Wheel Simulation
        let isDragging = false;
        document.querySelector('.timer-wheel-svg').addEventListener('mousedown', (e) => isDragging = true);
        window.addEventListener('mouseup', () => isDragging = false);
        window.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            const rect = document.querySelector('.timer-wheel-svg').getBoundingClientRect();
            const cx = rect.left + 130;
            const cy = rect.top + 130;
            const angle = Math.atan2(e.clientY - cy, e.clientX - cx) * (180 / Math.PI) + 90;
            let normalizedAngle = angle < 0 ? angle + 360 : angle;
            setTimer((normalizedAngle / 360) * 12);
        });

        // --- Session Logic ---
        function startParking() {
            if(!auth.currentUser) return openModal('auth-modal');
            if(vehicles.length === 0) return openModal('vehicle-modal');
            
            activeSession = { zone: selectedZone, plate: document.getElementById('selected-vehicle-display').innerText };
            startTime = new Date();
            document.getElementById('initial-sheet').classList.remove('active');
            document.getElementById('session-sheet').classList.add('active');
            document.getElementById('session-zone-display').innerText = activeSession.zone.id;
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const diff = Math.floor((new Date() - startTime) / 1000);
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('parking-timer').innerText = `${h}:${m}:${s}`;
            const cost = (diff / 3600) * activeSession.zone.price;
            document.getElementById('current-price-session').innerText = `${Math.max(0.10, cost).toFixed(2)} CHF`;
        }

        function stopParking() {
            document.getElementById('payment-amount').innerText = document.getElementById('current-price-session').innerText;
            openModal('twint-modal');
        }

        function completePayment() {
            clearInterval(timerInterval);
            document.getElementById('session-sheet').classList.remove('active');
            document.getElementById('initial-sheet').classList.add('active');
            closeModal('twint-modal');
            activeSession = null;
            alert("Paiement TWINT validé avec succès !");
        }

        // --- UI Helpers ---
        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- Init ---
        setTimer(1);
        updateVehicleUI();
    </script>
</body>
</html>
