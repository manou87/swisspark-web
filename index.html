<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwissPark – Louez votre place en toute simplicité</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sp-pink: #E6007E; --sp-dark: #2D2D2D; --sp-twint: #000; }
        body { font-family: 'Montserrat', sans-serif; background: #f8f9fa; overscroll-behavior: none; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-radius: 24px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); border: 1px solid rgba(0,0,0,0.05); }
        .btn-pink { background: var(--sp-pink); color: white; font-weight: 800; transition: 0.3s; border: none; }
        .btn-pink:active { transform: scale(0.95); }
        
        .onboarding-screen { position: fixed; inset: 0; background: white; z-index: 5000; padding: 2rem; display: flex; flex-direction: column; }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 32px 32px 0 0; z-index: 1000; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.32, 0.72, 0, 1); padding: 1.5rem; box-shadow: 0 -10px 40px rgba(0,0,0,0.1); }
        .bottom-sheet.active { transform: translateY(0); }
        
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 85px; background: white; border-top: 1px solid #f0f0f0; display: flex; justify-content: space-around; align-items: center; z-index: 1001; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 10px; color: #9ca3af; font-weight: 700; gap: 4px; text-transform: uppercase; }
        .nav-item.active { color: var(--sp-pink); }
        
        .price-tag { background: var(--sp-pink); color: white; padding: 4px 12px; border-radius: 20px; font-weight: 800; font-size: 14px; border: 2px solid white; box-shadow: 0 4px 12px rgba(230,0,126,0.3); }
        .twint-btn { background: var(--sp-twint); color: white; border-radius: 16px; padding: 1.2rem; font-weight: 800; width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; }
        
        .hidden { display: none !important; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>

    <!-- 1) ONBOARDING / AUTH (OBLIGATOIRE) -->
    <div id="onboarding" class="onboarding-screen">
        <div class="flex-1 flex flex-col justify-center">
            <h1 class="text-4xl font-black text-gray-800 mb-2">SwissPark</h1>
            <p class="text-gray-500 font-semibold mb-10">L'inscription est obligatoire pour accéder aux services.</p>
            
            <form id="signup-form" class="space-y-4">
                <input type="text" id="reg-name" placeholder="Nom Complet" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold" required>
                <input type="email" id="reg-email" placeholder="Email" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold" required>
                <input type="tel" id="reg-phone" placeholder="Numéro de téléphone" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold" required>
                <input type="password" id="reg-pass" placeholder="Mot de passe" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold" required>
                
                <label class="flex items-center gap-3 text-sm font-bold text-gray-600 px-2">
                    <input type="checkbox" required class="w-5 h-5 accent-pink-600">
                    J'accepte les conditions générales
                </label>
                
                <button type="submit" class="btn-pink w-full py-5 rounded-2xl font-black uppercase text-lg shadow-xl mt-4">S'inscrire</button>
            </form>
        </div>
    </div>

    <div id="app-content" class="hidden">
        <div id="map"></div>

        <!-- RECHERCHE -->
        <div class="fixed top-5 left-5 right-5 z-10">
            <div class="glass-panel p-4 flex items-center gap-3">
                <i class="fas fa-search text-gray-400"></i>
                <input type="text" placeholder="Où voulez-vous stationner ?" class="bg-transparent border-none outline-none font-bold text-gray-800 w-full">
            </div>
        </div>

        <!-- 2) MODAL VÉHICULE (OBLIGATOIRE AVANT RÉSERVATION) -->
        <div id="vehicle-modal" class="fixed inset-0 bg-black/60 z-[6000] hidden flex items-end justify-center">
            <div class="bg-white w-full max-w-md rounded-t-[32px] p-8">
                <h3 class="text-2xl font-black mb-6">Ajouter un véhicule</h3>
                <form id="vehicle-form" class="space-y-4">
                    <input type="text" id="veh-plate" placeholder="Numéro de plaque (ex: GE 123 456)" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold" required>
                    <input type="text" id="veh-type" placeholder="Marque / Modèle (Optionnel)" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold">
                    <input type="text" id="veh-color" placeholder="Couleur (Optionnel)" class="w-full bg-gray-50 p-5 rounded-2xl border-none outline-none font-bold">
                    <button type="submit" class="btn-pink w-full py-5 rounded-2xl font-black uppercase shadow-lg mt-2">Enregistrer</button>
                </form>
                <button onclick="toggleVehicleModal(false)" class="w-full py-4 text-gray-400 font-bold">Annuler</button>
            </div>
        </div>

        <!-- 5) DÉTAILS DU POINT SUR LA CARTE -->
        <div id="spot-sheet" class="bottom-sheet">
            <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-6"></div>
            <div class="flex justify-between items-start mb-4">
                <div>
                    <h3 id="spot-title" class="text-2xl font-black">Parking Centre</h3>
                    <p id="spot-addr" class="text-gray-400 font-bold text-sm">Avenue du Léman 10, Lausanne</p>
                </div>
                <div id="spot-is-covered" class="hidden bg-blue-50 text-blue-600 px-3 py-1 rounded-lg text-xs font-black uppercase tracking-wider">Moyen Couvert</div>
            </div>

            <div class="grid grid-cols-2 gap-3 mb-6">
                <img src="https://images.unsplash.com/photo-1506521781263-d8422e82f27a?auto=format&fit=crop&w=300" class="w-full h-32 object-cover rounded-2xl">
                <img src="https://images.unsplash.com/photo-1590674852885-93842129b751?auto=format&fit=crop&w=300" class="w-full h-32 object-cover rounded-2xl">
            </div>

            <!-- SÉLECTION DURÉE -->
            <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-3">Sélectionnez la durée</p>
            <div class="flex gap-2 overflow-x-auto no-scrollbar mb-6">
                <button onclick="setDuration('hour')" class="dur-btn flex-1 min-w-[80px] py-3 bg-gray-50 rounded-xl font-bold text-gray-600 border-2 border-transparent active:border-pink-600">1 Heure</button>
                <button onclick="setDuration('day')" class="dur-btn flex-1 min-w-[80px] py-3 bg-gray-50 rounded-xl font-bold text-gray-600 border-2 border-transparent">1 Jour</button>
                <button onclick="setDuration('week')" class="dur-btn flex-1 min-w-[80px] py-3 bg-gray-50 rounded-xl font-bold text-gray-600 border-2 border-transparent">1 Semaine</button>
                <button onclick="setDuration('month')" class="dur-btn flex-1 min-w-[80px] py-3 bg-gray-50 rounded-xl font-bold text-gray-600 border-2 border-transparent">1 Mois</button>
            </div>

            <div class="flex justify-between items-center mb-6 px-2">
                <span class="font-black text-gray-400">PRIX FINAL :</span>
                <span id="final-price" class="text-3xl font-black text-gray-800">0.00 CHF</span>
            </div>

            <div class="flex flex-col gap-3">
                <button onclick="processBooking()" class="twint-btn">
                    PAYER AVEC TWINT
                </button>
                <button onclick="openGPS()" class="w-full py-4 text-gray-400 font-bold flex items-center justify-center gap-2">
                    <i class="fas fa-location-arrow"></i> VOIR L'ITINÉRAIRE
                </button>
            </div>
        </div>

        <!-- 6) MODE PROPRIÉTAIRE -->
        <div id="owner-panel" class="fixed inset-0 bg-white z-[7000] hidden flex flex-col p-8">
            <h2 class="text-3xl font-black mb-2">Espace Propriétaire</h2>
            <p class="text-gray-500 font-bold mb-8">Gérez vos parkings et voyez vos gains.</p>
            
            <div class="bg-gray-50 p-6 rounded-3xl mb-8">
                <p class="text-xs font-black text-gray-400 uppercase tracking-widest mb-1">Gains totaux (Commission -10%)</p>
                <p class="text-4xl font-black text-gray-800">1'245.50 CHF</p>
            </div>

            <button onclick="toggleOwnerMode(false)" class="w-full py-5 bg-gray-100 rounded-2xl font-black uppercase text-gray-600">Retour à la Carte</button>
        </div>

        <nav class="nav-bar">
            <a href="#" class="nav-item active"><i class="fas fa-map text-xl"></i><span>Carte</span></a>
            <a href="#" onclick="toggleOwnerMode(true)" class="nav-item"><i class="fas fa-parking text-xl"></i><span>Louer</span></a>
            <a href="#" onclick="toggleVehicleModal(true)" class="nav-item"><i class="fas fa-car text-xl"></i><span>Véhicules</span></a>
            <a href="#" class="nav-item"><i class="fas fa-user-circle text-xl"></i><span>Compte</span></a>
        </nav>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- DATA STRUCTURE ---
        let user = JSON.parse(localStorage.getItem('sp_user')) || null;
        let vehicles = JSON.parse(localStorage.getItem('sp_vehicles')) || [];
        let selectedSpot = null;
        let currentDuration = 'hour';

        const FIXED_PRICES = { hour: 3, day: 15, week: 80, month: 250 };

        // --- INIT ---
        window.onload = () => {
            if (user) showApp();
        };

        function showApp() {
            document.getElementById('onboarding').classList.add('hidden');
            document.getElementById('app-content').classList.remove('hidden');
            initMap();
        }

        // --- MAP & SPOTS ---
        let map;
        const spots = [
            { id: 1, title: "Place Riponne", addr: "Place de la Riponne, Lausanne", pos: [46.5237, 6.6323], covered: true },
            { id: 2, title: "Gare Lausanne", addr: "Avenue de la Gare 1, Lausanne", pos: [46.5167, 6.6293], covered: false },
            { id: 3, title: "Bel-Air", addr: "Tour Bel-Air, Lausanne", pos: [46.5215, 6.6305], covered: true }
        ];

        function initMap() {
            if (map) return;
            map = L.map('map', { zoomControl: false, attributionControl: false }).setView([46.52, 6.63], 14);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);

            spots.forEach(spot => {
                const price = spot.covered ? FIXED_PRICES.hour * 2 : FIXED_PRICES.hour;
                const icon = L.divIcon({ 
                    className: 'custom-div-icon', 
                    html: `<div class="price-tag">${price} CHF</div>`,
                    iconSize: [60, 30]
                });
                L.marker(spot.pos, { icon }).addTo(map).on('click', () => openSpot(spot));
            });
        }

        function openSpot(spot) {
            selectedSpot = spot;
            document.getElementById('spot-title').innerText = spot.title;
            document.getElementById('spot-addr').innerText = spot.addr;
            document.getElementById('spot-is-covered').classList.toggle('hidden', !spot.covered);
            updateFinalPrice();
            document.getElementById('spot-sheet').classList.add('active');
        }

        function setDuration(dur) {
            currentDuration = dur;
            document.querySelectorAll('.dur-btn').forEach(b => b.classList.remove('border-pink-600', 'bg-pink-50', 'text-pink-600'));
            event.currentTarget.classList.add('border-pink-600', 'bg-pink-50', 'text-pink-600');
            updateFinalPrice();
        }

        function updateFinalPrice() {
            if (!selectedSpot) return;
            let p = FIXED_PRICES[currentDuration];
            if (selectedSpot.covered) p *= 2;
            document.getElementById('final-price').innerText = `${p.toFixed(2)} CHF`;
        }

        // --- ACTIONS ---
        function processBooking() {
            if (vehicles.length === 0) {
                alert("Vous devez ajouter un véhicule avant de réserver.");
                toggleVehicleModal(true);
                return;
            }
            // SIMULATION TWINT
            const total = document.getElementById('final-price').innerText;
            if (confirm(`Confirmer le paiement de ${total} avec TWINT ?`)) {
                alert("PAIEMENT RÉUSSI ! Votre réservation est confirmée.");
                document.getElementById('spot-sheet').classList.remove('active');
            }
        }

        function openGPS() {
            const url = `https://www.google.com/maps/dir/?api=1&destination=${selectedSpot.pos[0]},${selectedSpot.pos[1]}`;
            window.open(url, '_blank');
        }

        // --- UI CONTROLS ---
        document.getElementById('signup-form').onsubmit = (e) => {
            e.preventDefault();
            user = { name: document.getElementById('reg-name').value, phone: document.getElementById('reg-phone').value };
            localStorage.setItem('sp_user', JSON.stringify(user));
            showApp();
        };

        function toggleVehicleModal(show) {
            document.getElementById('vehicle-modal').classList.toggle('hidden', !show);
        }

        document.getElementById('vehicle-form').onsubmit = (e) => {
            e.preventDefault();
            const v = { plate: document.getElementById('veh-plate').value };
            vehicles.push(v);
            localStorage.setItem('sp_vehicles', JSON.stringify(vehicles));
            toggleVehicleModal(false);
            alert("Véhicule ajouté !");
        };

        function toggleOwnerMode(show) {
            document.getElementById('owner-panel').classList.toggle('hidden', !show);
        }
    </script>
</body>
</html>
