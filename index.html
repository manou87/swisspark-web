<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SwissPark - Le futur du parking en Suisse</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --sp-pink: #E6007E; --sp-dark: #2D2D2D; }
        body { font-family: 'Montserrat', sans-serif; background: #f8f9fa; overscroll-behavior: none; }
        #map { height: 100vh; width: 100%; z-index: 0; }
        .glass-panel { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border-radius: 20px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); }
        .btn-pink { background: var(--sp-pink); color: white; font-weight: 700; transition: all 0.3s; border: none; cursor: pointer; }
        .btn-pink:hover { transform: scale(1.02); filter: brightness(1.1); }
        .bottom-sheet { position: fixed; bottom: 0; left: 0; right: 0; background: white; border-radius: 30px 30px 0 0; z-index: 1000; transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); padding-bottom: calc(env(safe-area-inset-bottom) + 80px); }
        .bottom-sheet.active { transform: translateY(0); }
        .timer-wheel { width: 220px; height: 220px; border-radius: 50%; border: 12px solid #fdf2f8; position: relative; margin: 20px auto; display: flex; align-items: center; justify-content: center; cursor: pointer; user-select: none; }
        .timer-progress { position: absolute; top: -12px; left: -12px; width: 220px; height: 220px; border-radius: 50%; border: 12px solid var(--sp-pink); border-color: var(--sp-pink) transparent transparent transparent; transform: rotate(0deg); transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .nav-bar { position: fixed; bottom: 0; left: 0; right: 0; height: 75px; background: white; border-top: 1px solid #f3f4f6; display: flex; justify-content: space-around; align-items: center; z-index: 1001; padding-bottom: env(safe-area-inset-bottom); }
        .nav-item { display: flex; flex-direction: column; align-items: center; font-size: 11px; color: #9ca3af; text-decoration: none; font-weight: 600; gap: 4px; }
        .nav-item.active { color: var(--sp-pink); }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; align-items: flex-end; justify-content: center; }
        .modal-content { background: white; width: 100%; max-width: 500px; border-radius: 30px 30px 0 0; padding: 2rem; }
        @media (min-width: 640px) { .modal { align-items: center; } .modal-content { border-radius: 30px; margin: 1rem; } }
        .vehicle-tag { background: #1f2937; color: white; padding: 4px 10px; border-radius: 6px; font-family: 'Courier New', monospace; font-weight: 700; letter-spacing: 1px; }
        .pulse-pink { animation: pulse-pink 2s infinite; }
        @keyframes pulse-pink { 0% { box-shadow: 0 0 0 0 rgba(230, 0, 126, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(230, 0, 126, 0); } 100% { box-shadow: 0 0 0 0 rgba(230, 0, 126, 0); } }
        .hidden { display: none; }
    </style>
</head>
<body>
    <!-- Top Search / Logo Bar -->
    <div class="fixed top-6 left-1/2 -translate-x-1/2 w-[90%] max-w-md z-[1000]">
        <div class="glass-panel p-3 flex items-center gap-3 border border-white/20">
            <div class="bg-pink-600 p-2 rounded-xl text-white">
                <i class="fas fa-parking"></i>
            </div>
            <input type="text" id="zone-search" placeholder="Code de zone ou adresse" class="bg-transparent border-none outline-none w-full font-bold text-gray-800 placeholder:text-gray-400">
            <div id="user-status" class="text-pink-600 font-bold text-sm cursor-pointer" onclick="openModal('auth-modal')">
                <i class="fas fa-user-circle text-2xl"></i>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <!-- Initial Sheet: Zone Selection -->
    <div id="initial-sheet" class="bottom-sheet active shadow-2xl">
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto my-4 cursor-pointer"></div>
        <div class="px-6 pb-6">
            <div class="flex justify-between items-start mb-6">
                <div>
                    <h2 class="text-2xl font-bold text-gray-900" id="current-zone-name">Zone 1001</h2>
                    <p class="text-gray-500 font-semibold flex items-center gap-1">
                        <i class="fas fa-location-arrow text-xs text-pink-500"></i> Lausanne, Riponne
                    </p>
                </div>
                <div class="bg-pink-50 px-3 py-1 rounded-full border border-pink-100">
                    <span class="text-pink-600 font-bold text-lg" id="current-zone-price">2.50 CHF/h</span>
                </div>
            </div>
            
            <div class="timer-wheel" id="time-selector">
                <div class="timer-progress" id="progress-indicator"></div>
                <div class="text-center">
                    <span id="display-time" class="text-4xl font-black text-gray-800 block">01:00</span>
                    <span class="text-[10px] text-gray-400 font-bold uppercase tracking-[0.2em]">DURÉE DU PARKING</span>
                </div>
                <!-- Interactive knob (visual) -->
                <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-6 h-6 bg-white border-4 border-pink-600 rounded-full shadow-md"></div>
            </div>

            <div class="flex items-center justify-between bg-gray-50 p-4 rounded-2xl mb-4 border border-gray-100">
                <div class="flex items-center gap-3">
                    <div id="active-vehicle-icon" class="text-gray-400"><i class="fas fa-car text-xl"></i></div>
                    <div id="active-vehicle-info">
                        <span class="text-xs text-gray-400 font-bold block uppercase">Véhicule</span>
                        <span class="font-bold text-gray-800" id="selected-vehicle-display">Sélectionner...</span>
                    </div>
                </div>
                <button onclick="openModal('vehicle-modal')" class="text-pink-600 font-bold text-sm">Changer</button>
            </div>

            <button onclick="startParking()" class="btn-pink w-full py-5 rounded-2xl text-xl shadow-lg active:scale-95 flex items-center justify-center gap-3 pulse-pink">
                DÉMARRER
            </button>
        </div>
    </div>

    <!-- Active Session Sheet -->
    <div id="session-sheet" class="bottom-sheet shadow-2xl overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-1 bg-pink-600 animate-pulse"></div>
        <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto my-4"></div>
        <div class="px-6 pb-6 text-center">
            <div class="flex items-center justify-center gap-2 mb-2">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-ping"></span>
                <span class="text-[10px] font-black text-green-600 uppercase tracking-widest">Session Active</span>
            </div>
            <h3 class="text-5xl font-black text-gray-900 tracking-tighter mb-1" id="parking-timer">00:00:00</h3>
            <div class="flex items-center justify-center gap-2 mb-6 text-gray-500 font-bold">
                <span id="current-price-session">0.00 CHF</span>
                <span class="w-1 h-1 bg-gray-300 rounded-full"></span>
                <span id="session-zone-display">1001</span>
            </div>
            
            <div class="flex gap-3">
                <button class="flex-1 py-4 bg-gray-100 text-gray-700 font-bold rounded-2xl text-lg hover:bg-gray-200 transition">PROLONGER</button>
                <button onclick="stopParking()" class="flex-1 py-4 border-2 border-pink-500 text-pink-600 font-bold rounded-2xl text-lg active:bg-pink-50 transition">ARRÊTER</button>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-900">Bienvenue</h2>
                <button onclick="closeModal('auth-modal')" class="text-gray-400 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            <div id="phone-auth-container">
                <form id="phone-form" class="space-y-4">
                    <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                        <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Numéro de Mobile</label>
                        <input type="tel" id="phone-number" placeholder="+41 79 000 00 00" class="w-full bg-transparent border-none outline-none font-bold text-lg text-gray-800" required>
                    </div>
                    <div id="recaptcha-container"></div>
                    <button type="submit" class="btn-pink w-full py-4 rounded-2xl text-lg shadow-md">Continuer</button>
                </form>
            </div>
            <div id="verification-container" class="hidden space-y-4">
                <p class="text-sm text-gray-500">Entrez le code envoyé au <span id="display-phone" class="font-bold"></span></p>
                <form id="verification-form" class="space-y-4">
                    <input type="text" id="verification-code" placeholder="123456" class="w-full bg-gray-50 p-4 rounded-2xl border border-gray-100 text-center text-2xl font-black tracking-[0.5em] outline-none focus:border-pink-500" required>
                    <button type="submit" class="btn-pink w-full py-4 rounded-2xl text-lg shadow-md">Valider</button>
                </form>
            </div>
            <div id="profile-container" class="hidden text-center py-6">
                <div class="w-20 h-20 bg-pink-100 text-pink-600 rounded-full flex items-center justify-center text-3xl mx-auto mb-4">
                    <i class="fas fa-user"></i>
                </div>
                <h3 class="text-xl font-bold mb-1" id="logged-phone"></h3>
                <p class="text-gray-400 text-sm mb-6">Compte SwissPark Personnel</p>
                <button onclick="auth.signOut().then(()=>location.reload())" class="text-red-500 font-bold">Déconnexion</button>
            </div>
        </div>
    </div>

    <!-- Vehicle Modal -->
    <div id="vehicle-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-black text-gray-900">Mes Véhicules</h2>
                <button onclick="closeModal('vehicle-modal')" class="text-gray-400 text-2xl"><i class="fas fa-times"></i></button>
            </div>
            
            <div id="vehicle-list" class="space-y-3 mb-6">
                <!-- Vehicles go here -->
            </div>

            <form id="vehicle-form" onsubmit="addVehicle(event)" class="space-y-4 border-t pt-6">
                <div class="bg-gray-50 p-4 rounded-2xl border border-gray-100">
                    <label class="text-[10px] font-bold text-gray-400 uppercase tracking-widest mb-1 block">Plaque (ex: VD 123456)</label>
                    <input type="text" id="plate-number" class="w-full bg-transparent border-none outline-none font-black text-xl text-gray-800 uppercase" required>
                </div>
                <button type="submit" class="btn-pink w-full py-4 rounded-2xl text-lg shadow-md">Ajouter</button>
            </form>
        </div>
    </div>

    <!-- TWINT Modal -->
    <div id="twint-modal" class="modal">
        <div class="modal-content text-center !rounded-[40px] !max-w-xs mx-auto mb-10 sm:mb-auto">
            <div class="bg-[#000] p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto -mt-10 shadow-xl border-4 border-white mb-6">
                <img src="https://www.twint.ch/wp-content/themes/twint-2023/assets/images/logo-twint.svg" alt="TWINT" class="w-12 h-12">
            </div>
            <h2 class="text-2xl font-black text-gray-900 mb-2">TWINT</h2>
            <p class="text-gray-500 text-sm mb-6 font-semibold">Paiement instantané</p>
            
            <div class="bg-gray-50 rounded-3xl p-6 mb-6">
                <div class="text-[10px] font-bold text-gray-400 uppercase mb-1">Montant à payer</div>
                <div class="text-3xl font-black text-gray-900" id="payment-amount">0.00 CHF</div>
            </div>

            <button onclick="completePayment()" class="bg-[#000] text-white w-full py-5 rounded-3xl text-xl font-black flex items-center justify-center gap-3 active:scale-95 transition shadow-lg">
                PAYER AVEC TWINT
            </button>
            <button onclick="closeModal('twint-modal')" class="mt-4 text-gray-400 font-bold text-sm">Plus tard</button>
        </div>
    </div>

    <nav class="nav-bar">
        <a href="#" class="nav-item active"><i class="fas fa-map-marked-alt text-xl"></i><span>Carte</span></a>
        <a href="#" class="nav-item"><i class="fas fa-history text-xl"></i><span>Activité</span></a>
        <a href="#" onclick="openModal('vehicle-modal')" class="nav-item"><i class="fas fa-car text-xl"></i><span>Véhicules</span></a>
        <a href="#" onclick="openModal('auth-modal')" class="nav-item"><i class="fas fa-cog text-xl"></i><span>Paramètres</span></a>
    </nav>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script>
        // --- Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3uDEtxEcwxuRRqItU1G-sn5cAWse-gpc",
            authDomain: "swisspark-e4c0a.firebaseapp.com",
            projectId: "swisspark-e4c0a",
            storageBucket: "swisspark-e4c0a.firebasestorage.app",
            messagingSenderId: "852079002086",
            appId: "1:852079002086:web:e4de222417deff1aabd627"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        auth.languageCode = 'fr';

        // --- App State ---
        let vehicles = JSON.parse(localStorage.getItem('sp_vehicles')) || [];
        let activeSession = null;
        let timerInterval = null;
        let startTime = null;
        let confirmationResult;
        let selectedDuration = 1; // hours

        // --- Map Init ---
        const map = L.map('map', { zoomControl: false }).setView([46.5197, 6.6323], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: '&copy; SwissPark Switzerland'
        }).addTo(map);

        const parkingSpots = [
            { id: 1001, name: "Lausanne Centre", pos: [46.5197, 6.6323], price: 2.50 },
            { id: 1002, name: "Lausanne Gare", pos: [46.5167, 6.6293], price: 3.00 },
            { id: 2001, name: "Genève Centre", pos: [46.2044, 6.1432], price: 4.50 },
            { id: 3001, name: "Zurich HB", pos: [47.3779, 8.5402], price: 5.00 }
        ];

        parkingSpots.forEach(spot => {
            const marker = L.circleMarker(spot.pos, {
                radius: 12, fillColor: "#E6007E", color: "#fff", weight: 3, opacity: 1, fillOpacity: 0.8
            }).addTo(map);
            marker.on('click', () => {
                document.getElementById('current-zone-name').innerText = `Zone ${spot.id}`;
                document.getElementById('current-zone-price').innerText = `${spot.price.toFixed(2)} CHF/h`;
                selectedZone = spot;
                map.panTo(spot.pos);
            });
        });

        let selectedZone = parkingSpots[0];

        // --- Auth Logic ---
        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('recaptcha-container', { 'size': 'invisible' });
        
        document.getElementById('phone-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const phone = document.getElementById('phone-number').value;
            auth.signInWithPhoneNumber(phone, window.recaptchaVerifier).then(result => {
                confirmationResult = result;
                document.getElementById('phone-auth-container').classList.add('hidden');
                document.getElementById('verification-container').classList.remove('hidden');
                document.getElementById('display-phone').innerText = phone;
            }).catch(err => alert(err.message));
        });

        document.getElementById('verification-form').addEventListener('submit', function(e) {
            e.preventDefault();
            const code = document.getElementById('verification-code').value;
            confirmationResult.confirm(code).then(() => {
                location.reload();
            }).catch(() => alert("Code invalide."));
        });

        auth.onAuthStateChanged(user => {
            if(user) {
                document.getElementById('phone-auth-container').classList.add('hidden');
                document.getElementById('profile-container').classList.remove('hidden');
                document.getElementById('logged-phone').innerText = user.phoneNumber;
                document.getElementById('user-status').innerHTML = '<i class="fas fa-check-circle text-2xl text-green-500"></i>';
            }
        });

        // --- Vehicle Logic ---
        function addVehicle(e) {
            e.preventDefault();
            const plate = document.getElementById('plate-number').value.toUpperCase();
            vehicles.push({ plate, id: Date.now() });
            localStorage.setItem('sp_vehicles', JSON.stringify(vehicles));
            updateVehicleUI();
            document.getElementById('vehicle-form').reset();
        }

        function updateVehicleUI() {
            const list = document.getElementById('vehicle-list');
            const display = document.getElementById('selected-vehicle-display');
            if(vehicles.length === 0) {
                list.innerHTML = '<p class="text-gray-400 text-center py-4">Aucun véhicule</p>';
                display.innerText = "Sélectionner...";
                return;
            }
            list.innerHTML = vehicles.map(v => `
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-2xl border border-gray-100 cursor-pointer hover:border-pink-500 transition" onclick="selectVehicle('${v.plate}')">
                    <span class="vehicle-tag">${v.plate}</span>
                    <i class="fas fa-chevron-right text-gray-300"></i>
                </div>
            `).join('');
            if(!activeSession) selectVehicle(vehicles[0].plate);
        }

        function selectVehicle(plate) {
            document.getElementById('selected-vehicle-display').innerText = plate;
            document.getElementById('active-vehicle-icon').classList.remove('text-gray-400');
            document.getElementById('active-vehicle-icon').classList.add('text-pink-600');
            closeModal('vehicle-modal');
        }

        // --- Circular Selector ---
        let rotation = 0;
        document.getElementById('time-selector').addEventListener('click', () => {
            rotation = (rotation + 45) % 360;
            document.getElementById('progress-indicator').style.transform = `rotate(${rotation}deg)`;
            selectedDuration = Math.floor(rotation / 45) + 1;
            document.getElementById('display-time').innerText = `${selectedDuration.toString().padStart(2, '0')}:00`;
        });

        // --- Parking Session Logic ---
        function startParking() {
            if(!auth.currentUser) return openModal('auth-modal');
            if(vehicles.length === 0) return openModal('vehicle-modal');
            
            activeSession = { zone: selectedZone, plate: document.getElementById('selected-vehicle-display').innerText };
            startTime = new Date();
            
            document.getElementById('initial-sheet').classList.remove('active');
            document.getElementById('session-sheet').classList.add('active');
            document.getElementById('session-zone-display').innerText = activeSession.zone.id;
            
            timerInterval = setInterval(updateTimer, 1000);
        }

        function updateTimer() {
            const diff = Math.floor((new Date() - startTime) / 1000);
            const h = Math.floor(diff / 3600).toString().padStart(2, '0');
            const m = Math.floor((diff % 3600) / 60).toString().padStart(2, '0');
            const s = (diff % 60).toString().padStart(2, '0');
            document.getElementById('parking-timer').innerText = `${h}:${m}:${s}`;
            
            const cost = (diff / 3600) * activeSession.zone.price;
            document.getElementById('current-price-session').innerText = `${Math.max(0.10, cost).toFixed(2)} CHF`;
        }

        function stopParking() {
            document.getElementById('payment-amount').innerText = document.getElementById('current-price-session').innerText;
            openModal('twint-modal');
        }

        function completePayment() {
            clearInterval(timerInterval);
            document.getElementById('session-sheet').classList.remove('active');
            document.getElementById('initial-sheet').classList.add('active');
            closeModal('twint-modal');
            activeSession = null;
            alert("Paiement TWINT validé !");
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- Init ---
        updateVehicleUI();
    </script>
</body>
</html>
